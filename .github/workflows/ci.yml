on: [push, pull_request]
name: ci

permissions:
    contents: read

env:
    LOCAL_USERNAME: DailyDriver
    LOCAL_USERPASS: 4FW9kwTsGMGf4VvjZ33mfsET
    INSTALL_PACKAGES: 0

jobs:
    setup-scoop:
        name: Setup Environment
        runs-on: windows-latest
        defaults:
            run:
                shell: pwsh
        steps:
            - name: Create User Account for Transferring Ownership
              run: |
                $options = @{
                    Name = "${{env.LOCAL_USERNAME}}"
                    Password = ConvertTo-SecureString -String "${{env.LOCAL_USERPASS}}" -AsPlainText -Force
                }
                New-LocalUser @options
                Add-LocalGroupMember -Group "Administrators" -Member "${{env.LOCAL_USERNAME}}"
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup Environment
              run: |
                $pass = ConvertTo-SecureString -String "${{env.LOCAL_USERPASS}}" -AsPlainText -Force
                $cred = [System.Management.Automation.PSCredential]::new("${{env.LOCAL_USERNAME}}", $pass)
                Invoke-Command -ComputerName $env:COMPUTERNAME -Credential $cred -FilePath ".\setup_env.ps1" -ArgumentList $pwd.Path
            - name: Create Directory for Archiving
              run: |
                New-Item -ItemType Directory -Path ".\env" -Verbose
                New-Item -ItemType Junction -Path ".\env\scoop" -Target "C:\Users\${{env.LOCAL_USERNAME}}\scoop" -Verbose
                Move-Item "Microsoft.PowerShell_profile.ps1" ".\env" -Verbose
            - name: Upload Environment Archive
              uses: actions/upload-artifact@v4
              with:
                name: env
                path: env
                compression-level: 9