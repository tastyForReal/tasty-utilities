on: [push, pull_request]
name: ci

permissions:
    contents: read

jobs:
    setup-scoop:
        name: Setup Scoop
        runs-on: windows-latest
        defaults:
            run:
                shell: powershell
        steps:
            - name: Install Scoop and Scoop Packages
              run: |
                Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression

                . "$env:USERPROFILE\scoop\shims\scoop.ps1" update *
                . "$env:USERPROFILE\scoop\shims\scoop.ps1" install 7zip fastfetch ffmpeg nodejs oh-my-posh python wget
                . "$env:USERPROFILE\scoop\shims\scoop.ps1" cleanup *
                . "$env:USERPROFILE\scoop\shims\scoop.ps1" cache rm *

                # Export Scoop Paths
                $scoop_paths = ($env:Path -split ';' | Where-Object { $_ -like '*scoop*' }) -join ';'
                ";$scoop_paths" | Out-File scoop_paths.txt
            - name: Zip Scoop Directory
              run: |
                $7z_args = @(
                    'a',
                    '-t7z',
                    '-m0=lzma2',
                    '-mx=9',
                    '-mfb=64',
                    '-md=32m',
                    '-mhe=on',
                    '-p"725734"',
                    'scoop.7z',
                    "$env:USERPROFILE\scoop",
                    "scoop_paths.txt"
                )
                $7z_process = @{
                    FilePath     = "$env:USERPROFILE\scoop\shims\7z.exe"
                    ArgumentList = $7z_args
                    NoNewWindow  = $true
                    Wait         = $true
                }
                Start-Process @7z_process
            - name: Upload Scoop Archive
              uses: actions/upload-artifact@v4
              with:
                name: scoop
                path: scoop.7z